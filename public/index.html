<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>X 监控与转发面板</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="container-fluid py-3">
      <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap mb-3">
        <div>
          <h1 class="h4 mb-1">X 监控与转发面板</h1>
          <div class="text-secondary small">
            twitterapi.io（读数据）+ 官方 X API（写数据）+ 后台轮询监控 + 原推过滤 + 自动转发
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-secondary" id="monitorStatus">监控：未知</span>
          <button class="btn btn-sm btn-success" id="btnStartMonitor">开始监控</button>
          <button class="btn btn-sm btn-outline-danger" id="btnStopMonitor">停止监控</button>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div class="fw-semibold">配置</div>
              <div class="text-secondary small" id="statsBar">调用次数：0</div>
            </div>
            <div class="card-body">
              <form id="configForm" class="row gy-2 gx-3 align-items-end">
                <div class="col-12 col-md-4">
                  <label class="form-label">TwitterAPI.io API Key（X-API-Key）</label>
                  <input class="form-control" type="password" id="apiKey" placeholder="填入你的 API Key" />
                  <div class="form-text">
                    推荐直接在本页填写并保存到本机 `data/config.json`（不会提交到 git）。如果你没保存，这里为空时才会尝试读取 `.env` 的 `TWITTERAPI_IO_KEY`（如果用 `.env`，页面不会回显）。
                  </div>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label">目标账号（screen_name，逗号/换行分隔）</label>
                  <textarea class="form-control" id="targets" rows="2" placeholder="例如：elonmusk"></textarea>
                  <div class="form-text">如果这里为空，会尝试读取 `.env` 的 `MONITOR_TARGETS`；保存配置后立即生效。</div>
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label">轮询间隔（秒）</label>
                  <input class="form-control" type="number" id="pollIntervalSec" min="10" value="60" />
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label">每次抓取条数（上限）</label>
                  <input class="form-control" type="number" id="fetchLimit" min="1" value="20" />
                  <div class="form-text">接口单次默认返回 20 条；大于 20 会自动翻页（调用次数也会增加）。</div>
                </div>

                <div class="col-12 col-md-2 d-grid">
                  <button type="submit" class="btn btn-primary" id="btnSaveConfig">保存配置</button>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">过滤规则</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="skipMentions" />
                    <label class="form-check-label" for="skipMentions">开启后：文本中包含 “@” 的推文不入队/队列中也会跳过</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="skipQuotes" />
                    <label class="form-check-label" for="skipQuotes">开启后：引用推文（quote，带评论的转发）不入队/队列中也会跳过</label>
                  </div>
                </div>

                <div class="col-12">
                  <hr class="my-2" />
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label">转发模式</label>
                  <select class="form-select" id="forwardMode">
                    <option value="retweet">转推（retweet）</option>
                    <option value="create_tweet">发新推（create tweet）</option>
                  </select>
                </div>

                <div class="col-12 col-md-3">
                  <label class="form-label">发送间隔（秒）</label>
                  <input class="form-control" type="number" id="forwardSendIntervalSec" min="0" value="5" />
                  <div class="form-text">当一次发现多条新推时，会按顺序每隔 N 秒发一条。</div>
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label">启用转发</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="forwardEnabled" />
                    <label class="form-check-label" for="forwardEnabled">开启</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="forwardDryRun" checked />
                    <label class="form-check-label" for="forwardDryRun">Dry-run（只打印不调用）</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="forwardTranslateZh" />
                    <label class="form-check-label" for="forwardTranslateZh">翻译为中文（Google 免费）</label>
                  </div>
                  <div class="form-text">仅在“发新推（create tweet）”模式生效。</div>
                </div>

                <div class="col-12 col-md-4">
                  <div class="alert alert-info mb-0">
                    转发使用官方 X API（twitter-api-v2）。请在 `.env` 填：
                    `X_API_KEY` / `X_API_SECRET` / `X_ACCESS_TOKEN` / `X_ACCESS_SECRET`，并按需设置 `HTTPS_PROXY`（例如
                    `http://127.0.0.1:7890`）。
                    <div class="mt-2">
                      也可以直接在本页面填写并保存到本机 `data/config.json`（不会提交到 git）。
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <hr class="my-2" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">X API Key (Consumer Key)</label>
                  <input class="form-control" type="password" id="xApiKey" placeholder="填入官方 API Key" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">X API Secret (Consumer Secret)</label>
                  <input class="form-control" type="password" id="xApiSecret" placeholder="填入官方 API Secret" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">X Access Token</label>
                  <input class="form-control" type="password" id="xAccessToken" placeholder="填入 Access Token" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">X Access Token Secret</label>
                  <input class="form-control" type="password" id="xAccessSecret" placeholder="填入 Access Token Secret" />
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">HTTPS 代理（可选）</label>
                  <input class="form-control" id="forwardProxy" placeholder="例如：http://127.0.0.1:7890" />
                  <div class="form-text">
                    填了就优先用这里；不填则尝试读取 `.env` 的 `HTTPS_PROXY/HTTP_PROXY/ALL_PROXY`。
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header fw-semibold">手动测试实验室</div>
            <div class="card-body d-flex flex-column gap-3">
              <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-secondary" id="btnFetchLatest">
                  获取最新推文（前 5 条）
                </button>
                <button class="btn btn-outline-secondary" id="btnRunOnce">
                  监控：立即执行一次
                </button>
              </div>

              <div>
                <label class="form-label">模拟发推（create tweet）</label>
                <div class="input-group">
                  <input class="form-control" id="postText" placeholder="输入要发布的文本" />
                  <button class="btn btn-outline-primary" id="btnTestPost">发推测试</button>
                </div>
                <div class="form-text">需要已在 `.env` 配置官方 X API 的 4 个 Token（OAuth 1.0a）。</div>
              </div>

              <div>
                <label class="form-label">模拟转推（retweet）</label>
                <div class="input-group">
                  <input class="form-control" id="retweetId" placeholder="输入要转推的 tweet_id" />
                  <button class="btn btn-outline-primary" id="btnTestRetweet">转推测试</button>
                </div>
              </div>

              <div>
                <label class="form-label">搬运 tweet_id（下载文本+图片后发新推）</label>
                <div class="input-group">
                  <input class="form-control" id="repostId" placeholder="输入要搬运的 tweet_id" />
                  <button class="btn btn-outline-primary" id="btnTestRepost">搬运测试</button>
                </div>
                <div class="form-text">会先下载到本地 `data/downloads/<tweet_id>/`，再用官方 API 发推（受 Dry-run 开关影响）。</div>
              </div>

              <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-primary" id="btnTestXAuth">测试 X 鉴权（v2.me）</button>
              </div>

              <div>
                <div class="fw-semibold mb-2">过滤器测试（最近抓取）</div>
                <div class="table-responsive" style="max-height: 320px">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th style="width: 140px">类型</th>
                        <th>文本</th>
                        <th style="width: 220px">ID</th>
                      </tr>
                    </thead>
                    <tbody id="filterTableBody">
                      <tr><td colspan="3" class="text-secondary">暂无数据</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="flex-grow-1">
                <div class="fw-semibold mb-2">API 响应（JSON）</div>
                <pre class="json-box" id="apiResponse">{}</pre>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div class="fw-semibold">运行控制台（实时日志）</div>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-danger" id="btnClearQueue">清空队列</button>
                <button class="btn btn-sm btn-outline-secondary" id="btnClearLogs">清空日志</button>
              </div>
            </div>
            <div class="card-body">
              <pre class="log-box" id="logBox"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="/app.js"></script>
  </body>
</html>
